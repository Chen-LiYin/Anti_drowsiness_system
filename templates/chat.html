<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº’å‹•èŠå¤©å®¤ - é˜²çŒç¡ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
      body {
        margin: 0;
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        background: #0f1419;
        color: #fff;
      }
      .chat-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 40px;
      }
      .chat-panel {
        width: 360px;
        max-width: 95%;
        background: rgba(22, 33, 62, 0.95);
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(0, 212, 255, 0.12);
      }
      .chat-header {
        background: rgba(0, 212, 255, 0.12);
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        text-align: center;
      }
      .chat-header h3 {
        margin: 0;
        color: #00d4ff;
      }
      .chat-messages {
        height: 440px;
        overflow: auto;
        padding: 12px;
      }
      .chat-welcome {
        color: #aaa;
        text-align: center;
        padding: 20px 8px;
      }
      .chat-message {
        background: rgba(255, 255, 255, 0.04);
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #00d4ff;
      }
      .message-username {
        color: #00d4ff;
        font-weight: bold;
        margin-right: 8px;
      }
      .message-votes {
        background: rgba(231, 76, 60, 0.12);
        color: #e74c3c;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 0.8rem;
      }
      .chat-input-container {
        display: flex;
        gap: 8px;
        padding: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.03);
      }
      .chat-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
      }
      .chat-send-btn {
        background: linear-gradient(45deg, #00d4ff, #0099cc);
        border: none;
        color: #fff;
        padding: 10px 14px;
        border-radius: 16px;
        cursor: pointer;
      }
      .chat-status {
        padding: 10px 12px;
        text-align: center;
        color: #aaa;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="chat-sidebar">
      <div class="chat-panel">
        <div class="chat-header"><h3>ğŸ’¬ äº’å‹•èŠå¤©å®¤</h3></div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-welcome">
            <p>ğŸ¯ æ­¡è¿ä¾†åˆ°äº’å‹•èŠå¤©å®¤</p>
            <p>âœï¸ æ‚¨å¯ä»¥éš¨æ™‚ç•™è¨€ï¼ˆæ¯äººé™ä¸€å‰‡ï¼Œæœ€å¤š50å­—ï¼‰</p>
            <p>ğŸ—³ï¸ å¤§å®¶å¯ä»¥æŠ•ç¥¨çµ¦æœ€ä½³ç•™è¨€</p>
          </div>
        </div>
        <div class="chat-input-container">
          <input
            id="chat-input"
            class="chat-input"
            maxlength="50"
            placeholder="è¼¸å…¥æ‚¨çš„ç•™è¨€ï¼ˆæœ€å¤š50å­—ï¼‰..."
          />
          <button id="chat-send-btn" class="chat-send-btn">ç™¼é€</button>
        </div>
        <div class="chat-status" id="chat-status">
          ğŸ’¬ éš¨æ™‚å¯ä»¥ç•™è¨€ï¼ç­‰å¾…ä¸»äººè§¸ç™¼æŠ•ç¥¨...
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      let chatActive = false;
      let userVoted = false;

      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const chatSendBtn = document.getElementById('chat-send-btn');
      const chatStatus = document.getElementById('chat-status');

      function showNotification(msg, type = 'info') {
        // minimal notification: use alert fallback
        try {
          console.log('[NOTIF]', type, msg);
        } catch (e) {}
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function renderMessage(msg, canVote) {
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.dataset.messageId = msg.id;
        div.innerHTML = `<div><span class="message-username">${
          msg.username
        }</span> <span class="message-votes">â¤ï¸ ${
          msg.votes
        }</span></div><div class="message-text">${
          msg.message
        }</div><div style="font-size:0.8rem;color:#888;margin-top:6px;display:flex;justify-content:space-between;align-items:center;"><span>${formatTime(
          msg.timestamp
        )}</span>${
          canVote
            ? `<button style=\"background:#27ae60;color:#fff;border:none;padding:4px 8px;border-radius:8px;cursor:pointer;\" onclick=\"voteMessage('${msg.id}')\">ğŸ‘ æŠ•ç¥¨</button>`
            : ''
        }</div>`;
        return div;
      }

      function updateChatMessages(messages) {
        chatMessages.innerHTML = '';
        messages.forEach((msg) => {
          const canVote = !userVoted && chatActive;
          chatMessages.appendChild(renderMessage(msg, canVote));
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) {
          showNotification('è«‹è¼¸å…¥è¨Šæ¯', 'warning');
          return;
        }
        if (message.length > 50) {
          showNotification('è¨Šæ¯ä¸èƒ½è¶…é50å­—', 'warning');
          return;
        }
        socket.emit('send_message', { message });
        chatInput.value = '';
      }

      function voteMessage(id) {
        socket.emit('vote_message', { message_id: id });
      }

      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      // Socket events
      socket.on('connect', () => {
        socket.emit('get_chat_status');
      });

      socket.on('chat_status', (data) => {
        chatActive = data.active;
        userVoted = data.user_voted;
        if (data.active) {
          chatStatus.textContent = 'ğŸ¯ èŠå¤©æœƒè©±é€²è¡Œä¸­';
          updateChatMessages(data.messages);
        }
      });
      socket.on('new_message', (message) => {
        const canVote = !userVoted && chatActive;
        chatMessages.appendChild(renderMessage(message, canVote));
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (message.user_id !== socket.id)
          showNotification(`${message.username}: ${message.message}`, 'info');
      });
      socket.on('vote_update', (data) => {
        const messageDiv = document.querySelector(
          `[data-message-id="${data.message_id}"]`
        );
        if (messageDiv) {
          const votesSpan = messageDiv.querySelector('.message-votes');
          if (votesSpan) votesSpan.textContent = `â¤ï¸ ${data.votes}`;
        }
      });
      socket.on('vote_success', (d) => {
        userVoted = true;
        showNotification('æŠ•ç¥¨æˆåŠŸï¼', 'success');
        document.querySelectorAll('.vote-btn').forEach((b) => {
          b.disabled = true;
          b.textContent = 'å·²æŠ•ç¥¨';
        });
      });
      socket.on('chat_error', (d) => {
        showNotification(d.message, 'error');
      });
      socket.on('chat_session_started', (d) => {
        chatActive = true;
        userVoted = false;
        chatStatus.textContent = 'ğŸ¯ æŠ•ç¥¨å€’è¨ˆæ™‚é–‹å§‹ - 60 ç§’å…§å¿«ä¾†æŠ•ç¥¨ï¼';
        showNotification(d.message, 'success');
        socket.emit('get_chat_status');
      });
      socket.on('chat_timer_update', (d) => {
        /* optional */
      });
      socket.on('chat_timer_ended', (d) => {
        showNotification(d.message, 'info');
        socket.emit('get_chat_status');
        chatStatus.textContent = 'â° æŠ•ç¥¨å·²æˆªæ­¢ - ç­‰å¾…ä¸»äººé†’ä¾†çµç®—';
      });
      socket.on('chat_session_ended', (d) => {
        chatActive = false;
        userVoted = false;
        if (d.top_message) {
          showNotification(`ğŸ† ç²å‹ç•™è¨€: ${d.top_message.message}`, 'success');
          chatStatus.textContent = `ğŸ† ç²å‹è€…: ${d.top_message.username} (${d.top_message.votes} ç¥¨)`;
        } else {
          chatStatus.textContent = 'ğŸ’¬ ä¸»äººé†’ä¾†äº†ï¼';
        }
        setTimeout(() => {
          chatMessages.innerHTML = `<div class=\"chat-welcome\"><p>ğŸ¯ æ­¡è¿ä¾†åˆ°äº’å‹•èŠå¤©å®¤</p><p>âœï¸ æ‚¨å¯ä»¥éš¨æ™‚ç•™è¨€ï¼ˆæ¯äººé™ä¸€å‰‡ï¼Œæœ€å¤š50å­—ï¼‰</p></div>`;
          chatStatus.textContent = 'ğŸ’¬ éš¨æ™‚å¯ä»¥ç•™è¨€ï¼';
        }, 5000);
      });
    </script>
  </body>
</html>
