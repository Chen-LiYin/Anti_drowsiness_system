<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº’å‹•èŠå¤©å®¤ - é˜²çŒç¡ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="stylesheet" href="/static/vendor/toastify/toastify.css" />
    <script src="/static/vendor/toastify/toastify.js"></script>
    <script>
      (function () {
        function loadCSS(url) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = url;
          document.head.appendChild(l);
        }
        function loadScript(url, cb) {
          var s = document.createElement('script');
          s.src = url;
          s.onload = cb || function () {};
          document.head.appendChild(s);
        }
        setTimeout(function () {
          if (!window.Toastify) {
            loadCSS(
              'https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css'
            );
            loadScript(
              'https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js'
            );
          }
        }, 150);
      })();
    </script>
    <style>
      body {
        margin: 0;
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        background: #0f1419;
        color: #fff;
      }
      .chat-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 40px;
      }
      .notification-panel {
        width: 360px;
        max-width: 95%;
        background: rgba(22, 33, 62, 0.95);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(0, 212, 255, 0.12);
        margin-bottom: 16px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }
      .notification-panel.show {
        display: block;
      }
      .notification-item {
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .notification-item.info {
        background: linear-gradient(90deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 204, 0.2));
        border-left: 3px solid #00d4ff;
      }
      .notification-item.success {
        background: linear-gradient(90deg, rgba(0, 176, 155, 0.2), rgba(150, 201, 61, 0.2));
        border-left: 3px solid #00b09b;
      }
      .notification-item.warning {
        background: linear-gradient(90deg, rgba(243, 156, 18, 0.2), rgba(241, 196, 15, 0.2));
        border-left: 3px solid #f39c12;
      }
      .notification-item.error {
        background: linear-gradient(90deg, rgba(255, 95, 109, 0.2), rgba(255, 195, 113, 0.2));
        border-left: 3px solid #ff5f6d;
      }
      .notification-text {
        flex: 1;
        color: #fff;
      }
      .notification-link {
        background: rgba(0, 212, 255, 0.3);
        color: #00d4ff;
        padding: 6px 12px;
        border-radius: 12px;
        text-decoration: none;
        font-size: 0.9rem;
        white-space: nowrap;
        transition: all 0.3s;
      }
      .notification-link:hover {
        background: rgba(0, 212, 255, 0.5);
        color: #fff;
      }
      .notification-close {
        background: transparent;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0 4px;
      }
      .notification-close:hover {
        color: #fff;
      }
      .chat-panel {
        width: 360px;
        max-width: 95%;
        background: rgba(22, 33, 62, 0.95);
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(0, 212, 255, 0.12);
      }
      .chat-header {
        background: rgba(0, 212, 255, 0.12);
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        text-align: center;
      }
      .chat-header h3 {
        margin: 0;
        color: #00d4ff;
      }
      .chat-messages {
        height: 440px;
        overflow: auto;
        padding: 12px;
      }
      .chat-welcome {
        color: #aaa;
        text-align: center;
        padding: 20px 8px;
      }
      .chat-message {
        background: rgba(255, 255, 255, 0.04);
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #00d4ff;
      }
      .message-username {
        color: #00d4ff;
        font-weight: bold;
        margin-right: 8px;
      }
      .message-votes {
        background: rgba(231, 76, 60, 0.12);
        color: #e74c3c;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 0.8rem;
      }
      .chat-input-container {
        display: flex;
        gap: 8px;
        padding: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.03);
      }
      .chat-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
      }
      .chat-send-btn {
        background: linear-gradient(45deg, #00d4ff, #0099cc);
        border: none;
        color: #fff;
        padding: 10px 14px;
        border-radius: 16px;
        cursor: pointer;
      }
      .chat-status {
        padding: 10px 12px;
        text-align: center;
        color: #aaa;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="chat-sidebar">
      <!-- é€šçŸ¥é¢æ¿ -->
      <div class="notification-panel" id="notification-panel"></div>

      <div class="chat-panel">
        <div class="chat-header">
          <h3>ğŸ’¬ äº’å‹•èŠå¤©å®¤</h3>
          <div style="margin-top: 8px; display: flex; gap: 8px">
            <input
              id="nickname-input"
              placeholder="è¼¸å…¥æš±ç¨±ï¼ˆæœ€å¤š20å­—ï¼‰"
              style="
                padding: 6px 8px;
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.08);
                width: 140px;
                background: transparent;
                color: #fff;
              "
              maxlength="20"
            />
            <button
              id="set-nickname-btn"
              style="
                padding: 6px 10px;
                border-radius: 12px;
                border: none;
                background: #00d4ff;
                color: #000;
                cursor: pointer;
              "
            >
              è¨­å®šåç¨±
            </button>
          </div>
          <div
            id="timer-display"
            style="margin-top: 8px; color: #f39c12; display: none"
          >
            â±ï¸ <span id="timer-seconds">60</span>ç§’
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-welcome">
            <p>ğŸ¯ æ­¡è¿ä¾†åˆ°äº’å‹•èŠå¤©å®¤</p>
            <p>âœï¸ æ‚¨å¯ä»¥éš¨æ™‚ç•™è¨€ï¼ˆæ¯äººé™ä¸€å‰‡ï¼Œæœ€å¤š50å­—ï¼‰</p>
            <p>ğŸ—³ï¸ å¤§å®¶å¯ä»¥æŠ•ç¥¨çµ¦æœ€ä½³ç•™è¨€</p>
          </div>
        </div>
        <div class="chat-input-container">
          <input
            id="chat-input"
            class="chat-input"
            maxlength="50"
            placeholder="è¼¸å…¥æ‚¨çš„ç•™è¨€ï¼ˆæœ€å¤š50å­—ï¼‰..."
            disabled
          />
          <button id="chat-send-btn" class="chat-send-btn" disabled>
            ç™¼é€
          </button>
        </div>
        <div class="chat-status" id="chat-status">
          ğŸ’¬ éš¨æ™‚å¯ä»¥ç•™è¨€ï¼ç­‰å¾…ä¸»äººè§¸ç™¼æŠ•ç¥¨...
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      let chatActive = false;
      let userVoted = false;
      let myNickname = null;

      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const chatSendBtn = document.getElementById('chat-send-btn');
      const chatStatus = document.getElementById('chat-status');
      const notificationPanel = document.getElementById('notification-panel');

      // æ·»åŠ é‡è¦é€šçŸ¥åˆ°é¢æ¿ï¼ˆåƒ…ç”¨æ–¼æŠ•ç¥¨çµæœå’Œ URL é€£çµï¼‰
      function addNotificationToPanel(msg, type = 'info', url = null) {
        console.log('ğŸ“¢ addNotificationToPanel è¢«å‘¼å«:', { msg, type, url });
        const item = document.createElement('div');
        item.className = `notification-item ${type}`;

        const textSpan = document.createElement('span');
        textSpan.className = 'notification-text';
        textSpan.textContent = msg;
        item.appendChild(textSpan);

        if (url) {
          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.className = 'notification-link';
          link.textContent = 'é–‹å•Ÿ';
          item.appendChild(link);
          console.log('ğŸ”— å·²æ·»åŠ é€£çµæŒ‰éˆ•');
        }

        const closeBtn = document.createElement('button');
        closeBtn.className = 'notification-close';
        closeBtn.innerHTML = 'Ã—';
        closeBtn.onclick = () => {
          item.remove();
          if (notificationPanel.children.length === 0) {
            notificationPanel.classList.remove('show');
          }
        };
        item.appendChild(closeBtn);

        notificationPanel.appendChild(item);
        notificationPanel.classList.add('show');
        console.log('âœ… é€šçŸ¥å·²æ·»åŠ åˆ°é¢æ¿ï¼Œé¢æ¿æ‡‰è©²é¡¯ç¤ºäº†');

        // è‡ªå‹•ç§»é™¤ï¼ˆå¦‚æœæ²’æœ‰ URLï¼‰
        if (!url) {
          setTimeout(() => {
            if (item.parentNode) {
              item.remove();
              if (notificationPanel.children.length === 0) {
                notificationPanel.classList.remove('show');
              }
            }
          }, 8000);
        }
      }

      // ä¸€èˆ¬é€šçŸ¥ä½¿ç”¨ Toastifyï¼ˆå¾å³é‚Šå½ˆå‡ºï¼‰
      function showNotification(msg, type = 'info') {
        const colors = {
          success: 'linear-gradient(90deg, #00b09b, #96c93d)',
          error: 'linear-gradient(90deg, #ff5f6d, #ffc371)',
          warning: 'linear-gradient(90deg, #f39c12, #f1c40f)',
          info: 'linear-gradient(90deg, #00d4ff, #0099cc)',
        };
        const bg = colors[type] || colors.info;
        if (window.Toastify) {
          Toastify({
            text: msg,
            duration: 4000,
            gravity: 'top',
            position: 'right',
            close: true,
            style: { background: bg },
          }).showToast();
        } else {
          try {
            console.log('[NOTIF]', type, msg);
          } catch (e) {}
          // fallback
          alert(msg);
        }
      }

      // é¡¯ç¤ºå¸¶é€£çµçš„ toastï¼ˆè¨Šæ¯ + å¯é»æ“Šé€£çµï¼‰- å¾å³é‚Šå½ˆå‡º
      function showLinkToast(message, url, type = 'info') {
        const bg =
          {
            success: 'linear-gradient(90deg, #00b09b, #96c93d)',
            error: 'linear-gradient(90deg, #ff5f6d, #ffc371)',
            warning: 'linear-gradient(90deg, #f39c12, #f1c40f)',
            info: 'linear-gradient(90deg, #00d4ff, #0099cc)',
          }[type] || 'linear-gradient(90deg, #00d4ff, #0099cc)';

        if (window.Toastify) {
          Toastify({
            node: (function () {
              const n = document.createElement('div');
              const t = document.createTextNode(message + ' ');
              const a = document.createElement('a');
              a.href = url;
              a.target = '_blank';
              a.style.color = '#fff';
              a.style.textDecoration = 'underline';
              a.textContent = 'é»æ­¤é–‹å•Ÿ';
              n.appendChild(t);
              n.appendChild(a);
              return n;
            })(),
            duration: 10000,
            gravity: 'top',
            position: 'right',
            close: true,
            style: { background: bg },
          }).showToast();
        } else {
          alert(message + '\n' + url);
        }
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function renderMessage(msg, canVote) {
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.dataset.messageId = msg.id;
        div.innerHTML = `<div><span class="message-username">${
          msg.username
        }</span> <span class="message-votes">â¤ï¸ ${
          msg.votes
        }</span></div><div class="message-text">${
          msg.message
        }</div><div style="font-size:0.8rem;color:#888;margin-top:6px;display:flex;justify-content:space-between;align-items:center;"><span>${formatTime(
          msg.timestamp
        )}</span>${
          canVote
            ? `<button style=\"background:#27ae60;color:#fff;border:none;padding:4px 8px;border-radius:8px;cursor:pointer;\" onclick=\"voteMessage('${msg.id}')\">ğŸ‘ æŠ•ç¥¨</button>`
            : ''
        }</div>`;
        return div;
      }

      function updateChatMessages(messages) {
        chatMessages.innerHTML = '';
        messages.forEach((msg) => {
          const canVote = !userVoted && chatActive && msg.user_id !== socket.id;
          chatMessages.appendChild(renderMessage(msg, canVote));
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) {
          showNotification('è«‹è¼¸å…¥è¨Šæ¯', 'warning');
          return;
        }
        if (!myNickname) {
          showNotification('è«‹å…ˆè¨­å®šæš±ç¨±', 'warning');
          return;
        }
        if (message.length > 50) {
          showNotification('è¨Šæ¯ä¸èƒ½è¶…é50å­—', 'warning');
          return;
        }
        socket.emit('send_message', { message });
        chatInput.value = '';
      }

      function voteMessage(id) {
        socket.emit('vote_message', { message_id: id });
      }

      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      // Socket events
      socket.on('connect', () => {
        socket.emit('get_chat_status');
      });

      // è¨­å®šæš±ç¨±
      const nicknameInput = document.getElementById('nickname-input');
      const setNicknameBtn = document.getElementById('set-nickname-btn');
      setNicknameBtn.addEventListener('click', () => {
        const nick = nicknameInput.value.trim();
        if (!nick) {
          showNotification('æš±ç¨±ä¸èƒ½ç‚ºç©º', 'warning');
          return;
        }
        socket.emit('set_nickname', { nickname: nick });
      });

      socket.on('nickname_set', (data) => {
        myNickname = data.nickname;
        showNotification(`å·²è¨­å®šæš±ç¨±ï¼š${myNickname}`, 'success');
        // å•Ÿç”¨è¼¸å…¥
        chatInput.disabled = false;
        document.getElementById('chat-send-btn').disabled = false;
        // å°‡æš±ç¨±è¼¸å…¥é–å®š
        nicknameInput.disabled = true;
        setNicknameBtn.disabled = true;
      });

      socket.on('chat_status', (data) => {
        chatActive = data.active;
        userVoted = data.user_voted;
        if (data.active) {
          chatStatus.textContent = 'ğŸ¯ èŠå¤©æœƒè©±é€²è¡Œä¸­';
          updateChatMessages(data.messages);
        }
      });
      socket.on('new_message', (message) => {
        const canVote =
          !userVoted && chatActive && message.user_id !== socket.id;
        chatMessages.appendChild(renderMessage(message, canVote));
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (message.user_id !== socket.id)
          showNotification(`${message.username}: ${message.message}`, 'info');
      });
      socket.on('vote_update', (data) => {
        const messageDiv = document.querySelector(
          `[data-message-id="${data.message_id}"]`
        );
        if (messageDiv) {
          const votesSpan = messageDiv.querySelector('.message-votes');
          if (votesSpan) votesSpan.textContent = `â¤ï¸ ${data.votes}`;
        }
      });
      socket.on('vote_success', (d) => {
        userVoted = true;
        showNotification('æŠ•ç¥¨æˆåŠŸï¼', 'success');
        document.querySelectorAll('.vote-btn').forEach((b) => {
          b.disabled = true;
          b.textContent = 'å·²æŠ•ç¥¨';
        });
      });
      socket.on('chat_error', (d) => {
        showNotification(d.message, 'error');
      });
      socket.on('chat_session_started', (d) => {
        chatActive = true;
        userVoted = false;
        chatStatus.textContent = 'ğŸ¯ æŠ•ç¥¨å€’è¨ˆæ™‚é–‹å§‹ - 60 ç§’å…§å¿«ä¾†æŠ•ç¥¨ï¼';
        // é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚
        const timerEl = document.getElementById('timer-display');
        const timerSeconds = document.getElementById('timer-seconds');
        if (timerEl && timerSeconds) {
          timerEl.style.display = 'block';
          timerSeconds.textContent = d.duration || 60;
        }
        showNotification(d.message, 'success');
        socket.emit('get_chat_status');
      });
      socket.on('chat_timer_update', (d) => {
        const timerSeconds = document.getElementById('timer-seconds');
        if (timerSeconds) timerSeconds.textContent = d.time_remaining;
      });
      socket.on('chat_timer_ended', (d) => {
        showNotification(d.message, 'info');
        socket.emit('get_chat_status');
        chatStatus.textContent = ' æŠ•ç¥¨å·²æˆªæ­¢ - ç­‰å¾…ä¸»äººé†’ä¾†çµç®—';
      });
      socket.on('chat_session_ended', (d) => {
        console.log('ğŸ¯ æ”¶åˆ° chat_session_ended äº‹ä»¶:', d);
        chatActive = false;
        userVoted = false;
        if (d.top_message) {
          console.log('âœ… æœ‰ç²å‹ç•™è¨€ï¼Œæº–å‚™é¡¯ç¤ºé¢æ¿');
          // æŠ•ç¥¨çµæœé¡¯ç¤ºåœ¨é¢æ¿
          addNotificationToPanel(
            `ğŸ† ç²å‹ç•™è¨€: ${d.top_message.message} - ${d.top_message.username} (${d.top_message.votes} ç¥¨)`,
            'success'
          );
          chatStatus.textContent = `ğŸ† ç²å‹è€…: ${d.top_message.username} (${d.top_message.votes} ç¥¨)`;

          // å¦‚æœ payload åŒ…å« control_url ä¸”ç•¶å‰ä½¿ç”¨è€…ç‚ºç²å‹è€…ï¼ˆæ¯”å°æš±ç¨±ï¼‰ï¼Œé¡¯ç¤ºæ§åˆ¶é€£çµ
          if (
            d.control_url &&
            myNickname &&
            d.top_message.username === myNickname
          ) {
            console.log('ğŸ† ç•¶å‰ç”¨æˆ¶æ˜¯ç²å‹è€…ï¼Œé¡¯ç¤ºæ§åˆ¶é€£çµ');
            chatStatus.innerHTML = `ğŸ† ä½ ç²å‹ï¼<a href="${d.control_url}" style="color:#00d4ff;">é»æ­¤é€²å…¥æ§åˆ¶ä»‹é¢</a>`;
          }
        } else {
          console.log('âŒ æ²’æœ‰ç²å‹ç•™è¨€');
          chatStatus.textContent = 'ğŸ’¬ ä¸»äººé†’ä¾†äº†ï¼';
        }
        setTimeout(() => {
          chatMessages.innerHTML = `<div class=\"chat-welcome\"><p>ğŸ¯ æ­¡è¿ä¾†åˆ°äº’å‹•èŠå¤©å®¤</p><p>âœï¸ æ‚¨å¯ä»¥éš¨æ™‚ç•™è¨€ï¼ˆæ¯äººé™ä¸€å‰‡ï¼Œæœ€å¤š50å­—ï¼‰</p></div>`;
          chatStatus.textContent = 'ğŸ’¬ éš¨æ™‚å¯ä»¥ç•™è¨€ï¼';
        }, 5000);
      });
      // æ¥æ”¶æ§åˆ¶é€£çµæˆ–ç›£æ§é€£çµ - é¡¯ç¤ºåœ¨é¢æ¿
      socket.on('control_link', (data) => {
        console.log('ğŸ† æ”¶åˆ° control_link äº‹ä»¶:', data);
        if (data && data.url) {
          // ä½¿ç”¨é¢æ¿é¡¯ç¤ºå¯é»æ“Šé€£çµ
          addNotificationToPanel(
            'ğŸ† æ‚¨ç²å¾—æ§åˆ¶æ¬Šï¼Œé»æ“Šä»¥é€²å…¥æ§åˆ¶ä»‹é¢',
            'success',
            data.url
          );
          // åœ¨ç‹€æ…‹æ¬„ä¹Ÿé¡¯ç¤ºé€£çµ
          chatStatus.innerHTML = `ğŸ† <a href="${data.url}" style="color:#00d4ff;">é»æ­¤é€²å…¥æ§åˆ¶ä»‹é¢</a>`;
        }
      });

      socket.on('monitor_link', (data) => {
        console.log('ğŸ” æ”¶åˆ° monitor_link äº‹ä»¶:', data);
        if (data && data.url) {
          // ä½¿ç”¨é¢æ¿é¡¯ç¤ºå¯é»æ“Šé€£çµ
          addNotificationToPanel('ğŸ” å·²æ”¶åˆ°ç›£æ§é€£çµï¼ˆåƒ…è§€çœ‹ï¼‰', 'info', data.url);
          chatStatus.innerHTML = `ğŸ” <a href="${data.url}" style="color:#00d4ff;">é»æ­¤é€²å…¥ç›£æ§ç•«é¢</a>`;
        }
      });
    </script>
  </body>
</html>
