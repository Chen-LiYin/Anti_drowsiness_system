<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çŒç¡ç›£æ§ - æ™ºèƒ½é˜²çŒç¡ç³»çµ±</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <!-- Toastify (local with CDN fallback) -->
    <link rel="stylesheet" href="/static/vendor/toastify/toastify.css" />
    <script src="/static/vendor/toastify/toastify.js"></script>
    <script>
      (function () {
        function loadCSS(url) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = url;
          document.head.appendChild(l);
        }
        function loadScript(url, cb) {
          var s = document.createElement('script');
          s.src = url;
          s.onload = cb || function () {};
          document.head.appendChild(s);
        }
        setTimeout(function () {
          if (!window.Toastify) {
            loadCSS(
              'https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css'
            );
            loadScript(
              'https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js'
            );
          }
        }, 150);
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
      }

      .video-panel,
      .info-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .video-container {
        position: relative;
        width: 100%;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
      }

      #videoFeed {
        width: 100%;
        height: auto;
        display: block;
      }

      .status-badge {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1.2em;
        margin: 15px 0;
      }

      .status-alert {
        background: #28a745;
        color: white;
      }
      .status-tired {
        background: #ffc107;
        color: black;
      }
      .status-yawning {
        background: #ff9800;
        color: white;
      }
      .status-drowsy {
        background: #dc3545;
        color: white;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-start {
        background: #28a745;
        color: white;
      }

      .btn-stop {
        background: #dc3545;
        color: white;
      }

      .btn-reset {
        background: #6c757d;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .alert-banner {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 20px 30px;
        background: #dc3545;
        color: white;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.2em;
        display: none;
        animation: slideIn 0.3s;
        z-index: 1000;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¯ æ™ºèƒ½é˜²çŒç¡ç›£æ§ç³»çµ±</h1>
        <p>å³æ™‚çŒç¡åµæ¸¬èˆ‡è­¦å ±</p>
      </div>

      <div class="main-content">
        <!-- è¦–è¨Šé¢æ¿ -->
        <div class="video-panel">
          <h2>ğŸ“¹ å³æ™‚ç›£æ§</h2>
          <div class="video-container">
            <img id="videoFeed" src="/video_feed" alt="è¦–è¨Šä¸²æµ" />
          </div>

          <div class="controls">
            <button class="btn btn-start" onclick="startMonitoring()">
              â–¶ï¸ é–‹å§‹ç›£æ§
            </button>
            <button class="btn btn-stop" onclick="stopMonitoring()">
              â¸ï¸ åœæ­¢ç›£æ§
            </button>
            <button class="btn btn-reset" onclick="resetStats()">
              ğŸ”„ é‡ç½®çµ±è¨ˆ
            </button>
          </div>
        </div>

        <!-- è³‡è¨Šé¢æ¿ -->
        <div class="info-panel">
          <h2>ğŸ“Š å³æ™‚è³‡è¨Š</h2>

          <!-- ç‹€æ…‹é¡¯ç¤º -->
          <div style="text-align: center">
            <span id="statusBadge" class="status-badge status-alert"
              >æº–å‚™ä¸­...</span
            >
          </div>

          <!-- å³æ™‚æ•¸æ“š -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="earValue">0.000</div>
              <div class="stat-label">çœ¼ç›é•·å¯¬æ¯” (EAR)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="marValue">0.000</div>
              <div class="stat-label">å˜´å·´é•·å¯¬æ¯” (MAR)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="eyeCounter">0</div>
              <div class="stat-label">é–‰çœ¼å¹€æ•¸</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="yawnCounter">0</div>
              <div class="stat-label">æ‰“å“ˆæ¬ å¹€æ•¸</div>
            </div>
          </div>

          <!-- äº‹ä»¶çµ±è¨ˆ -->
          <h3 style="margin-top: 30px; margin-bottom: 15px">ğŸ“ˆ äº‹ä»¶çµ±è¨ˆ</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalDrowsy" style="color: #dc3545">
                0
              </div>
              <div class="stat-label">çŒç¡äº‹ä»¶</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalYawns" style="color: #ff9800">
                0
              </div>
              <div class="stat-label">æ‰“å“ˆæ¬ äº‹ä»¶</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalFrames">0</div>
              <div class="stat-label">ç¸½å¹€æ•¸</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="fps">0</div>
              <div class="stat-label">FPS</div>
            </div>
          </div>

          <!-- é‹è¡Œæ™‚é–“ -->
          <div style="margin-top: 20px; text-align: center; color: #666">
            <p>
              é‹è¡Œæ™‚é–“:
              <span id="runtime" style="font-weight: bold">00:00:00</span>
            </p>
            <p style="font-size: 0.9em; margin-top: 5px">
              é€£æ¥ç‹€æ…‹:
              <span id="connectionStatus" style="color: #28a745">â—</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- è­¦å ±æ©«å¹… -->
    <div id="alertBanner" class="alert-banner">âš ï¸ çŒç¡è­¦å ±ï¼è«‹ä¿æŒæ¸…é†’ï¼</div>

    <script>
      // WebSocket é€£æ¥
      const socket = io();

      // ç‹€æ…‹å°æ‡‰
      const statusConfig = {
        Alert: { class: 'status-alert', text: 'âœ… æ¸…é†’' },
        Tired: { class: 'status-tired', text: 'ğŸ˜´ ç–²å€¦' },
        Yawning: { class: 'status-yawning', text: 'ğŸ¥± æ‰“å“ˆæ¬ ' },
        Drowsy: { class: 'status-drowsy', text: 'âš ï¸ çŒç¡ä¸­' },
        'No Face': { class: 'status-badge', text: 'âŒ æœªåµæ¸¬åˆ°è‡‰éƒ¨' },
      };

      // é‹è¡Œæ™‚é–“è¨ˆæ™‚å™¨
      let runtimeInterval = null;
      let startTime = null;

      // WebSocket äº‹ä»¶è™•ç†
      socket.on('connect', function () {
        console.log('âœ… å·²é€£æ¥åˆ°ä¼ºæœå™¨');
        $('#connectionStatus').css('color', '#28a745').text('â—');
      });

      // é¡¯ç¤ºå¯é»æ“Šçš„ Toastify é€£çµ
      function showLinkToast(message, url, type = 'info') {
        var bg =
          {
            success: 'linear-gradient(90deg, #00b09b, #96c93d)',
            error: 'linear-gradient(90deg, #ff5f6d, #ffc371)',
            warning: 'linear-gradient(90deg, #f39c12, #f1c40f)',
            info: 'linear-gradient(90deg, #00d4ff, #0099cc)',
          }[type] || 'linear-gradient(90deg, #00d4ff, #0099cc)';

        if (window.Toastify) {
          Toastify({
            text: message,
            duration: 10000,
            close: true,
            gravity: 'top',
            position: 'right',
            style: { background: bg },
            node: (function () {
              var n = document.createElement('div');
              var a = document.createElement('a');
              a.href = url;
              a.target = '_blank';
              a.style.color = '#fff';
              a.style.textDecoration = 'underline';
              a.textContent = ' é»æ­¤é–‹å•Ÿ';
              n.appendChild(document.createTextNode(message));
              n.appendChild(a);
              return n;
            })(),
          }).showToast();
        } else {
          console.log(message, url);
        }
      }

      socket.on('disconnect', function () {
        console.log('âŒ å·²æ–·é–‹é€£æ¥');
        $('#connectionStatus').css('color', '#dc3545').text('â—');
      });

      socket.on('detection_result', function (data) {
        // æ›´æ–°ç‹€æ…‹æ¨™ç±¤
        const status = statusConfig[data.state];
        $('#statusBadge')
          .removeClass()
          .addClass('status-badge ' + status.class)
          .text(status.text);

        // æ›´æ–°å³æ™‚æ•¸æ“š
        $('#earValue').text(data.ear.toFixed(3));
        $('#marValue').text(data.mar.toFixed(3));
        $('#eyeCounter').text(data.eye_counter);
        $('#yawnCounter').text(data.yawn_counter);

        // æ›´æ–°çµ±è¨ˆ
        $('#totalDrowsy').text(data.total_drowsy);
        $('#totalYawns').text(data.total_yawns);
        $('#fps').text(data.fps);
      });

      socket.on('drowsy_alert', function (data) {
        console.warn('âš ï¸ çŒç¡è­¦å ±ï¼', data);
        showAlert();

        // å¯é¸ï¼šæ’­æ”¾éŸ³æ•ˆ
        // playAlertSound();
      });

      socket.on('yawn_warning', function (data) {
        console.log('ğŸ¥± æ‰“å“ˆæ¬ è­¦å‘Š', data);
      });

      // æ¥æ”¶ç›£æ§æˆ–æ§åˆ¶é€£çµ
      socket.on('monitor_link', function (data) {
        if (data && data.url) {
          showLinkToast('ğŸ” å·²æ”¶åˆ°ç›£æ§é€£çµ', data.url, 'info');
        }
      });

      socket.on('control_link', function (data) {
        if (data && data.url) {
          showLinkToast('ğŸ† å·²æ”¶åˆ°æ§åˆ¶é€£çµï¼Œé»æ“Šé–‹å•Ÿ', data.url, 'success');
        }
      });

      // åŠŸèƒ½å‡½æ•¸
      function startMonitoring() {
        $.post('/api/start', function (response) {
          console.log('âœ…', response.message);
          startTime = Date.now();
          if (!runtimeInterval) {
            runtimeInterval = setInterval(updateRuntime, 1000);
          }
        });
      }

      function stopMonitoring() {
        $.post('/api/stop', function (response) {
          console.log('â¸ï¸', response.message);
          if (runtimeInterval) {
            clearInterval(runtimeInterval);
            runtimeInterval = null;
          }
        });
      }

      function resetStats() {
        if (confirm('ç¢ºå®šè¦é‡ç½®çµ±è¨ˆæ•¸æ“šå—ï¼Ÿ')) {
          $.post('/api/reset_stats', function (response) {
            console.log('ğŸ”„', response.message);
            // é‡ç½®é¡¯ç¤º
            $('#totalDrowsy').text('0');
            $('#totalYawns').text('0');
            $('#totalFrames').text('0');
            startTime = Date.now();
          });
        }
      }

      function showAlert() {
        $('#alertBanner').fadeIn();
        setTimeout(function () {
          $('#alertBanner').fadeOut();
        }, 3000);
      }

      function updateRuntime() {
        if (startTime) {
          const elapsed = Date.now() - startTime;
          const hours = Math.floor(elapsed / 3600000);
          const minutes = Math.floor((elapsed % 3600000) / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);

          const timeStr =
            String(hours).padStart(2, '0') +
            ':' +
            String(minutes).padStart(2, '0') +
            ':' +
            String(seconds).padStart(2, '0');

          $('#runtime').text(timeStr);
        }
      }

      // å®šæœŸç²å–çµ±è¨ˆæ•¸æ“š
      setInterval(function () {
        $.get('/api/stats', function (data) {
          $('#totalFrames').text(data.total_frames.toLocaleString());
        });
      }, 5000);

      // é é¢è¼‰å…¥å®Œæˆ
      $(document).ready(function () {
        console.log('ğŸ“± ç›£æ§ä»‹é¢å·²è¼‰å…¥');
      });
    </script>
  </body>
</html>
