# èŠå¤©å®¤ç³»çµ±æŠ€è¡“æ–‡ä»¶

> **é˜²çŒç¡ç³»çµ± - äº’å‹•èŠå¤©å®¤æ¨¡çµ„**
> ç‰ˆæœ¬ï¼š1.0
> æœ€å¾Œæ›´æ–°ï¼š2025-12-15

---

## ğŸ“‹ ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [æª”æ¡ˆæ¶æ§‹](#æª”æ¡ˆæ¶æ§‹)
3. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
4. [Socket.IO äº‹ä»¶ API](#socketio-äº‹ä»¶-api)
5. [å®Œæ•´æµç¨‹åœ–](#å®Œæ•´æµç¨‹åœ–)
6. [Token å®‰å…¨æ©Ÿåˆ¶](#token-å®‰å…¨æ©Ÿåˆ¶)
7. [Socket ID è™•ç†æ©Ÿåˆ¶](#socket-id-è™•ç†æ©Ÿåˆ¶)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [é–‹ç™¼æ³¨æ„äº‹é …](#é–‹ç™¼æ³¨æ„äº‹é …)

---

## ç³»çµ±æ¦‚è¿°

### åŠŸèƒ½èªªæ˜

äº’å‹•èŠå¤©å®¤æ˜¯é˜²çŒç¡ç³»çµ±çš„ç¤¾äº¤äº’å‹•æ¨¡çµ„ï¼Œç•¶ç³»çµ±åµæ¸¬åˆ°ä½¿ç”¨è€…çŒç¡æ™‚ï¼Œæœƒè‡ªå‹•é–‹å•ŸèŠå¤©æœƒè©±ï¼Œè®“åœ¨ç·šçš„æœ‹å‹å¯ä»¥ç•™è¨€ä¸¦æŠ•ç¥¨ï¼Œæœ€é«˜ç¥¨è€…å°‡ç²å¾—æ°´æ§æ§åˆ¶æ¬Šã€‚

### ä¸»è¦ç‰¹é»

- âœ… **å³æ™‚é€šè¨Š**ï¼šåŸºæ–¼ Socket.IO å¯¦ç¾çš„å³æ™‚èŠå¤©
- âœ… **æŠ•ç¥¨æ©Ÿåˆ¶**ï¼šæ¯äººé™ä¸€å‰‡ç•™è¨€ï¼Œå¯æŠ•ç¥¨çµ¦å…¶ä»–äºº
- âœ… **è‡ªå‹•å€’æ•¸**ï¼š60 ç§’å€’æ•¸è¨ˆæ™‚ï¼Œæ™‚é–“åˆ°è‡ªå‹•è¨ˆç®—çµæœ
- âœ… **æ§åˆ¶æ¬Šæˆäºˆ**ï¼šæœ€é«˜ç¥¨è€…ç²å¾—ä¸€æ¬¡æ€§æ§åˆ¶é€£çµ
- âœ… **å®‰å…¨æ©Ÿåˆ¶**ï¼šToken é©—è­‰ + å¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…
- âœ… **å¤šå¹³å°é€šçŸ¥**ï¼šToastify + Notification Panel + Telegram

---

## æª”æ¡ˆæ¶æ§‹

### æ ¸å¿ƒæª”æ¡ˆ

```
anti_drowsiness_system/
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ web_remote_control.py       # å¾Œç«¯ä¸»é‚è¼¯ï¼ˆFlask + SocketIOï¼‰
â”‚   â””â”€â”€ integrated_system.py        # ç³»çµ±æ•´åˆï¼ˆè§¸ç™¼èŠå¤©æœƒè©±ï¼‰
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ chat.html                   # èŠå¤©å®¤å‰ç«¯é é¢
â”‚   â””â”€â”€ remote_control.html         # æ§åˆ¶é é¢ï¼ˆå« token è™•ç†ï¼‰
â”‚
â”œâ”€â”€ static/
â”‚   â””â”€â”€ vendor/
â”‚       â””â”€â”€ toastify/               # Toastify é€šçŸ¥åº«
â”‚           â”œâ”€â”€ toastify.css
â”‚           â””â”€â”€ toastify.js
â”‚
â””â”€â”€ document/
    â””â”€â”€ èŠå¤©å®¤ç³»çµ±æŠ€è¡“æ–‡ä»¶.md       # æœ¬æ–‡ä»¶
```

### æª”æ¡ˆèªªæ˜

| æª”æ¡ˆ                          | åŠŸèƒ½          | è¡Œæ•¸é‡é»  |
| ----------------------------- | ------------- | --------- |
| **web_remote_control.py**     | å¾Œç«¯ä¸»é‚è¼¯    |           |
| - `start_chat_session()`      | é–‹å§‹èŠå¤©æœƒè©±  | L820-848  |
| - `chat_timer_countdown()`    | å€’æ•¸è¨ˆæ™‚å™¨    | L850-875  |
| - `end_chat_session()`        | çµæŸèŠå¤©æœƒè©±  | L877-924  |
| - `award_control_to_winner()` | æˆäºˆæ§åˆ¶æ¬Š    | L931-1030 |
| - `generate_one_time_token()` | ç”Ÿæˆ Token    | L646-654  |
| - `validate_and_use_token()`  | é©—è­‰ Token    | L656-672  |
| **chat.html**                 | èŠå¤©å®¤å‰ç«¯    |           |
| - `showNotification()`        | Toastify é€šçŸ¥ | L448-497  |
| - `addNotificationToPanel()`  | é¢æ¿é€šçŸ¥      | L399-446  |
| - Socket äº‹ä»¶ç›£è½             | äº‹ä»¶è™•ç†      | L519-661  |
| **remote_control.html**       | æ§åˆ¶é é¢      |           |
| - Token è‡ªå‹•æª¢æ¸¬              | é€£æ¥è™•ç†      | L800-812  |
| **integrated_system.py**      | ç³»çµ±æ•´åˆ      |           |
| - çŒç¡æª¢æ¸¬                    | è§¸ç™¼èŠå¤©      | L495-506  |
| - æ¸…é†’æª¢æ¸¬                    | çµæŸèŠå¤©      | L516-560  |

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. èŠå¤©æœƒè©±ç®¡ç†

#### é–‹å§‹æœƒè©±

```python
# è§¸ç™¼æ¢ä»¶ï¼šæŒçºŒçŒç¡ 5 ç§’
def start_chat_session(self):
    self.chat_active = True
    self.chat_time_remaining = 60
    self.chat_timer_active = True

    # å»£æ’­é–‹å§‹äº‹ä»¶
    self.socketio.emit('chat_session_started', {
        'session_id': self.chat_session_id,
        'duration': 60,
        'message': 'ä¸»äººç¡è‘—äº†ï¼å¿«ä¾†ç•™è¨€å§ï¼'
    }, room='controllers')

    # å•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨
    threading.Thread(target=self.chat_timer_countdown, daemon=True).start()
```

#### å€’æ•¸è¨ˆæ™‚

```python
def chat_timer_countdown(self):
    while self.chat_timer_active and self.chat_time_remaining > 0:
        time.sleep(1)
        self.chat_time_remaining -= 1

        # æ¯ç§’å»£æ’­å‰©é¤˜æ™‚é–“
        self.socketio.emit('chat_timer_update', {
            'time_remaining': self.chat_time_remaining
        }, room='controllers')

    # æ™‚é–“åˆ°ï¼Œè‡ªå‹•çµæŸæœƒè©±
    if self.chat_timer_active:
        self.end_chat_session()  # â† é—œéµï¼šè‡ªå‹•èª¿ç”¨
```

#### çµæŸæœƒè©±

```python
def end_chat_session(self):
    # 1. åœæ­¢è¨ˆæ™‚å™¨
    self.chat_timer_active = False

    # 2. è¨ˆç®—æœ€é«˜ç¥¨
    top_message = self.get_top_voted_message()

    # 3. æˆäºˆæ§åˆ¶æ¬Š
    if top_message:
        winner_user_id = top_message['user_id']
        control_url = self.award_control_to_winner(winner_user_id, top_message)

    # 4. å»£æ’­çµæŸäº‹ä»¶
    self.socketio.emit('chat_session_ended', {
        'top_message': top_message,
        'message': 'ä¸»äººé†’ä¾†äº†ï¼',
        'control_url': control_url
    }, room='controllers')
```

### 2. æŠ•ç¥¨æ©Ÿåˆ¶

#### æŠ•ç¥¨é™åˆ¶

- âœ… æ¯äººé™æŠ•ä¸€ç¥¨
- âœ… ä¸èƒ½æŠ•çµ¦è‡ªå·±
- âœ… åªèƒ½åœ¨èŠå¤©æœƒè©±é€²è¡Œä¸­æŠ•ç¥¨
- âœ… ç¥¨æ•¸å³æ™‚åŒæ­¥çµ¦æ‰€æœ‰äºº

#### æŠ•ç¥¨è™•ç†

```python
@self.socketio.on('vote_message')
def handle_vote_message(data):
    user_id = request.sid
    message_id = data.get('message_id')

    # é©—è­‰æŠ•ç¥¨
    if user_id in self.chat_votes:
        emit('chat_error', {'message': 'æ‚¨å·²ç¶“æŠ•éç¥¨äº†'})
        return

    # è¨˜éŒ„æŠ•ç¥¨
    self.chat_votes[user_id] = message_id
    message['votes'] += 1

    # å»£æ’­æ›´æ–°
    self.socketio.emit('vote_update', {
        'message_id': message_id,
        'votes': message['votes']
    }, room='controllers')
```

### 3. æ§åˆ¶æ¬Šæˆäºˆ

#### ç”Ÿæˆä¸€æ¬¡æ€§ Token

```python
def generate_one_time_token(self, ttl=300):
    """ç”Ÿæˆä¸€æ¬¡æ€§ tokenï¼Œé è¨­æœ‰æ•ˆæœŸ 300 ç§’"""
    token = secrets.token_urlsafe(16)
    self.one_time_tokens[token] = {
        'expires_at': time.time() + ttl,
        'used': False
    }
    return token
```

#### æˆäºˆæµç¨‹

```python
def award_control_to_winner(self, winner_user_id, top_message):
    # 1. ç”Ÿæˆ Token
    token = self.generate_one_time_token()

    # 2. ç”Ÿæˆæ§åˆ¶é€£çµ
    control_url = f"http://{local_ip}:{port}/remote_control?auth={password}&token={token}"

    # 3. æ’¤éŠ·èˆŠæ§åˆ¶è€…
    if self.control_active and self.current_controller:
        self.revoke_remote_control(reason="æœ€é«˜ç¥¨è€…ç²å¾—æ§åˆ¶æ¬Š")

    # 4. ç™¼é€æ§åˆ¶é€£çµçµ¦ç²å‹è€…
    self.socketio.emit('control_link', {
        'url': control_url,
        'token': token,
        'message': 'æ­å–œç²å¾—æ§åˆ¶æ¬Šï¼'
    }, room=winner_user_id)

    # 5. ç™¼é€ç›£æ§é€£çµçµ¦å…¶ä»–äºº
    for cid in self.connected_clients:
        if cid != winner_user_id:
            self.socketio.emit('monitor_link', {
                'url': monitor_url
            }, room=cid)

    return control_url
```

---

## Socket.IO äº‹ä»¶ API

### å¾Œç«¯ â†’ å‰ç«¯äº‹ä»¶

| äº‹ä»¶åç¨±                 | è§¸ç™¼æ™‚æ©Ÿ           | Payload                                              | æ¥æ”¶è€…   |
| ------------------------ | ------------------ | ---------------------------------------------------- | -------- |
| **chat_session_started** | é–‹å§‹èŠå¤©æœƒè©±       | `{session_id, duration, message}`                    | æ‰€æœ‰äºº   |
| **chat_timer_update**    | æ¯ç§’å€’æ•¸           | `{time_remaining}`                                   | æ‰€æœ‰äºº   |
| **chat_warning**         | å‰©é¤˜ 10 ç§’         | `{message}`                                          | æ‰€æœ‰äºº   |
| **chat_timer_ended**     | å€’æ•¸çµæŸ           | `{message}`                                          | æ‰€æœ‰äºº   |
| **chat_session_ended**   | èŠå¤©æœƒè©±çµæŸ       | `{top_message, message, control_url}`                | æ‰€æœ‰äºº   |
| **new_message**          | æ–°ç•™è¨€             | `{id, user_id, username, message, votes, timestamp}` | æ‰€æœ‰äºº   |
| **vote_update**          | ç¥¨æ•¸æ›´æ–°           | `{message_id, votes}`                                | æ‰€æœ‰äºº   |
| **vote_success**         | æŠ•ç¥¨æˆåŠŸ           | `{message}`                                          | æŠ•ç¥¨è€…   |
| **control_link**         | æ§åˆ¶é€£çµï¼ˆç²å‹è€…ï¼‰ | `{url, token, message}`                              | ç²å‹è€…   |
| **monitor_link**         | ç›£æ§é€£çµï¼ˆå…¶ä»–äººï¼‰ | `{url}`                                              | å…¶ä»–äºº   |
| **winner_offline**       | ç²å‹è€…é›¢ç·š         | `{message, control_url}`                             | æ‰€æœ‰äºº   |
| **control_granted**      | æ§åˆ¶æ¬Šæˆäºˆ         | `{controller_id, emergency, reason}`                 | æ§åˆ¶è€…   |
| **control_revoked**      | æ§åˆ¶æ¬Šæ’¤éŠ·         | `{reason, message}`                                  | è¢«æ’¤éŠ·è€… |
| **chat_error**           | éŒ¯èª¤è¨Šæ¯           | `{message}`                                          | ç™¼é€è€…   |

### å‰ç«¯ â†’ å¾Œç«¯äº‹ä»¶

| äº‹ä»¶åç¨±            | ç”¨é€”                  | Payload        | å›æ‡‰äº‹ä»¶                             |
| ------------------- | --------------------- | -------------- | ------------------------------------ |
| **set_nickname**    | è¨­å®šæš±ç¨±              | `{nickname}`   | `nickname_set`                       |
| **send_message**    | ç™¼é€ç•™è¨€              | `{message}`    | `new_message`                        |
| **vote_message**    | æŠ•ç¥¨                  | `{message_id}` | `vote_success` / `vote_update`       |
| **get_chat_status** | ç²å–èŠå¤©ç‹€æ…‹          | ç„¡             | `chat_status`                        |
| **claim_token**     | ä½¿ç”¨ Token ç²å–æ§åˆ¶æ¬Š | `{token}`      | `control_granted` / `control_denied` |
| **control_start**   | ä¸€èˆ¬æ§åˆ¶æ¬Šè«‹æ±‚        | ç„¡             | `control_granted` / `control_denied` |

---

## å®Œæ•´æµç¨‹åœ–

### ä¸»æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      èŠå¤©å®¤å®Œæ•´æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ ã€çŒç¡åµæ¸¬ã€‘
   integrated_system.py æª¢æ¸¬åˆ°çŒç¡ç‹€æ…‹
   æŒçºŒ 5 ç§’ â†’ ç¢ºèªçŒç¡
   â”‚
   â””â”€â–º start_chat_session()
        â”œâ”€â–º è¨­å®š chat_active = True
        â”œâ”€â–º è¨­å®š chat_time_remaining = 60
        â”‚
        â”œâ”€â–º emit('chat_session_started') ğŸ”„
        â”‚    â””â”€â–º å‰ç«¯æ”¶åˆ°ï¼š
        â”‚         â”œâ”€â–º é¡¯ç¤º Toastifyï¼šã€Œä¸»äººç¡è‘—äº†ï¼å¿«ä¾†ç•™è¨€å§ï¼ã€
        â”‚         â”œâ”€â–º é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨ï¼šâ±ï¸ 60 ç§’
        â”‚         â””â”€â–º å•Ÿç”¨ç•™è¨€åŠŸèƒ½
        â”‚
        â””â”€â–º å•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨ Thread

2ï¸âƒ£ ã€ä½¿ç”¨è€…äº’å‹•ã€‘
   ä½¿ç”¨è€…åœ¨èŠå¤©å®¤ä¸­ï¼š
   â”‚
   â”œâ”€â–º è¨­å®šæš±ç¨±
   â”‚    emit('set_nickname', {nickname})
   â”‚    â””â”€â–º æ”¶åˆ°ï¼šnickname_set
   â”‚
   â”œâ”€â–º ç™¼é€ç•™è¨€
   â”‚    emit('send_message', {message})
   â”‚    â””â”€â–º å»£æ’­ï¼šnew_message (çµ¦æ‰€æœ‰äºº)
   â”‚
   â””â”€â–º æŠ•ç¥¨
        emit('vote_message', {message_id})
        â””â”€â–º å»£æ’­ï¼švote_update (çµ¦æ‰€æœ‰äºº)
             â””â”€â–º ç™¼é€è€…æ”¶åˆ°ï¼švote_success

3ï¸âƒ£ ã€å€’æ•¸è¨ˆæ™‚ã€‘
   chat_timer_countdown() èƒŒæ™¯åŸ·è¡Œ
   â”‚
   â”œâ”€â–º æ¯ç§’ç™¼é€
   â”‚    emit('chat_timer_update', {time_remaining})
   â”‚    â””â”€â–º å‰ç«¯æ›´æ–°é¡¯ç¤ºï¼šâ±ï¸ 59, 58, 57...
   â”‚
   â”œâ”€â–º å‰©é¤˜ 10 ç§’
   â”‚    emit('chat_warning', {message: 'å‰©é¤˜ 10 ç§’ï¼'})
   â”‚
   â””â”€â–º 60 ç§’å¾Œæ™‚é–“åˆ°
        emit('chat_timer_ended', {message})
        â””â”€â–º è‡ªå‹•èª¿ç”¨ end_chat_session() â† é—œéµï¼

4ï¸âƒ£ ã€çµæŸæœƒè©±ã€‘
   end_chat_session()
   â”‚
   â”œâ”€â–º get_top_voted_message()
   â”‚    â””â”€â–º æŒ‰ç¥¨æ•¸æ’åºï¼Œè¿”å›æœ€é«˜ç¥¨è¨Šæ¯
   â”‚
   â”œâ”€â–º award_control_to_winner()
   â”‚    â”‚
   â”‚    â”œâ”€â–º ç”Ÿæˆ Token (ä¸€æ¬¡æ€§ï¼Œ5åˆ†é˜æœ‰æ•ˆ)
   â”‚    â”‚
   â”‚    â”œâ”€â–º ç”Ÿæˆæ§åˆ¶ URL
   â”‚    â”‚    http://192.168.1.100:5000/remote_control?auth=xxx&token=AbC123
   â”‚    â”‚
   â”‚    â”œâ”€â–º æ’¤éŠ·èˆŠæ§åˆ¶è€…ï¼ˆå¦‚æœæœ‰ï¼‰
   â”‚    â”‚    emit('control_revoked', {reason})
   â”‚    â”‚
   â”‚    â”œâ”€â–º ç™¼é€æ§åˆ¶é€£çµ (çµ¦ç²å‹è€…)
   â”‚    â”‚    emit('control_link', {url, token}) â†’ room: winner_user_id
   â”‚    â”‚    â””â”€â–º å‰ç«¯æ”¶åˆ°ï¼š
   â”‚    â”‚         â”œâ”€â–º Toastify å½ˆå‡ºï¼šã€ŒğŸ† æ­å–œç²å‹ï¼ã€+ ğŸ”— æŒ‰éˆ•
   â”‚    â”‚         â”œâ”€â–º Notification Panel é¡¯ç¤º
   â”‚    â”‚         â””â”€â–º ç‹€æ…‹æ¬„é¡¯ç¤ºé‡‘è‰²è¶…é€£çµ
   â”‚    â”‚
   â”‚    â”œâ”€â–º ç™¼é€ç›£æ§é€£çµ (çµ¦å…¶ä»–äºº)
   â”‚    â”‚    emit('monitor_link', {url}) â†’ é™¤äº†ç²å‹è€…
   â”‚    â”‚    â””â”€â–º å‰ç«¯æ”¶åˆ°ï¼š
   â”‚    â”‚         â”œâ”€â–º Toastify å½ˆå‡ºï¼šã€ŒğŸ” ç›£æ§é€£çµã€+ ğŸ”— æŒ‰éˆ•
   â”‚    â”‚         â””â”€â–º Notification Panel é¡¯ç¤º
   â”‚    â”‚
   â”‚    â””â”€â–º ç™¼é€ Telegram é€šçŸ¥
   â”‚
   â””â”€â–º emit('chat_session_ended', {top_message})
        â””â”€â–º å‰ç«¯æ”¶åˆ°ï¼š
             â”œâ”€â–º é¡¯ç¤ºç²å‹è€…è³‡è¨Š
             â””â”€â–º 8 ç§’å¾Œé‡ç½®ç•«é¢

5ï¸âƒ£ ã€ç²å‹è€…ç²å–æ§åˆ¶æ¬Šã€‘
   ç²å‹è€…é»æ“Šã€ŒğŸ”— é–‹å•Ÿã€æŒ‰éˆ•
   â”‚
   â”œâ”€â–º é–‹å•Ÿæ–°åˆ†é ï¼šhttp://192.168.1.100:5000/remote_control?...&token=AbC123
   â”‚
   â””â”€â–º remote_control.html è¼‰å…¥
        â”‚
        â”œâ”€â–º Socket.IO é€£æ¥å»ºç«‹ (æ–°çš„ Socket ID)
        â”‚
        â”œâ”€â–º socket.on('connect') è§¸ç™¼
        â”‚    â”‚
        â”‚    â”œâ”€â–º æª¢æ¸¬ URL ä¸­çš„ token åƒæ•¸ âœ…
        â”‚    â”‚
        â”‚    â””â”€â–º emit('claim_token', {token: 'AbC123'})
        â”‚
        â””â”€â–º å¾Œç«¯ handle_claim_token()
             â”‚
             â”œâ”€â–º validate_and_use_token('AbC123') âœ… æœ‰æ•ˆ
             â”‚
             â”œâ”€â–º å¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…ï¼ˆå¦‚æœæœ‰ï¼‰
             â”‚
             â”œâ”€â–º è¨­å®šæ–°æ§åˆ¶è€…
             â”‚    self.control_active = True
             â”‚    self.current_controller = new_socket_id
             â”‚
             â””â”€â–º emit('control_granted', {controller_id})
                  â””â”€â–º ç²å‹è€…ç¾åœ¨å¯ä»¥æ§åˆ¶æ°´æ§äº†ï¼âœ…
```

### Socket ID è®ŠåŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Socket ID åœ¨ä¸åŒé é¢é–“çš„è®ŠåŒ–                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™‚é–“è»¸ï¼š
â”‚
â”œâ”€â–º T0: ä½¿ç”¨è€…é–‹å•ŸèŠå¤©å®¤é é¢
â”‚    URL: http://192.168.1.100:5000/chat
â”‚    Socket é€£æ¥: sid_A (ä¾‹å¦‚: R1oq3eTYAagT8HslAAAB)
â”‚    ç‹€æ…‹ï¼šå¯ä»¥ç™¼é€ç•™è¨€ã€æŠ•ç¥¨
â”‚
â”œâ”€â–º T1: æŠ•ç¥¨çµæŸï¼Œæˆç‚ºç²å‹è€…
â”‚    â”œâ”€â–º å¾Œç«¯è¨ˆç®—æœ€é«˜ç¥¨
â”‚    â”œâ”€â–º ç”Ÿæˆ Token: "AbC123XyZ"
â”‚    â””â”€â–º ç™¼é€ control_link â†’ room: sid_A
â”‚         â””â”€â–º å‰ç«¯ (sid_A) æ”¶åˆ°æ§åˆ¶é€£çµ
â”‚
â”œâ”€â–º T2: ç²å‹è€…é»æ“Šã€ŒğŸ”— é–‹å•Ÿã€æŒ‰éˆ•
â”‚    â”œâ”€â–º é–‹å•Ÿæ–°åˆ†é 
â”‚    â””â”€â–º URL: http://192.168.1.100:5000/remote_control?...&token=AbC123XyZ
â”‚
â””â”€â–º T3: æ§åˆ¶é é¢è¼‰å…¥
     â”œâ”€â–º Socket é€£æ¥: sid_B (ä¾‹å¦‚: 5iEaPtwFava4GmmhAAAZ) â† ä¸åŒï¼
     â”œâ”€â–º æª¢æ¸¬åˆ° URL ä¸­çš„ token
     â”œâ”€â–º emit('claim_token', {token: 'AbC123XyZ'})
     â”‚
     â””â”€â–º å¾Œç«¯é©—è­‰ Token âœ…
          â”œâ”€â–º æ’¤éŠ·èˆŠæ§åˆ¶è€…ï¼ˆå¦‚æœ current_controller != sid_Bï¼‰
          â”œâ”€â–º è¨­å®šæ–°æ§åˆ¶è€… = sid_B
          â””â”€â–º emit('control_granted') â†’ room: sid_B

é—œéµé»ï¼š
- sid_A (èŠå¤©å®¤) å’Œ sid_B (æ§åˆ¶é é¢) æ˜¯ä¸åŒçš„ Socket é€£æ¥
- ä¸èƒ½ç›´æ¥æˆæ¬Šçµ¦ sid_Aï¼Œå› ç‚ºæ§åˆ¶é é¢ä½¿ç”¨çš„æ˜¯ sid_B
- ä½¿ç”¨ Token æ©Ÿåˆ¶è§£æ±ºè·¨é é¢æˆæ¬Šå•é¡Œ
```

---

## Token å®‰å…¨æ©Ÿåˆ¶

### Token ç‰¹æ€§

| ç‰¹æ€§         | èªªæ˜                                    | å¯¦ä½œä½ç½®                            |
| ------------ | --------------------------------------- | ----------------------------------- |
| **ä¸€æ¬¡æ€§**   | Token ä½¿ç”¨å¾Œæ¨™è¨˜ç‚º `used`ï¼Œç„¡æ³•é‡è¤‡ä½¿ç”¨ | `validate_and_use_token()` L661     |
| **æ™‚æ•ˆæ€§**   | é è¨­æœ‰æ•ˆæœŸ 300 ç§’ï¼ˆ5 åˆ†é˜ï¼‰             | `generate_one_time_token()` L646    |
| **è‡ªå‹•æ¸…ç†** | éæœŸ Token æœƒåœ¨é©—è­‰æ™‚è‡ªå‹•åˆªé™¤           | `validate_and_use_token()` L652-658 |
| **å¼·åˆ¶æˆæ¬Š** | ä½¿ç”¨ Token æœƒå¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…           | `handle_claim_token()` L620-629     |
| **å®‰å…¨æ€§**   | ä½¿ç”¨ `secrets.token_urlsafe(16)` ç”Ÿæˆ   | `generate_one_time_token()` L648    |

### Token è³‡æ–™çµæ§‹

```python
self.one_time_tokens = {
    "AbC123XyZ": {
        "expires_at": 1734259200.0,  # Unix timestamp
        "used": False
    }
}
```

### Token é©—è­‰æµç¨‹

```python
def validate_and_use_token(self, token):
    info = self.one_time_tokens.get(token)

    # 1. Token ä¸å­˜åœ¨
    if not info:
        return False

    # 2. Token å·²ä½¿ç”¨
    if info.get('used'):
        return False

    # 3. Token å·²éæœŸ
    if time.time() > info.get('expires_at', 0):
        del self.one_time_tokens[token]  # è‡ªå‹•æ¸…ç†
        return False

    # 4. Token æœ‰æ•ˆï¼Œæ¨™è¨˜ç‚ºå·²ä½¿ç”¨
    info['used'] = True
    return True
```

### å®‰å…¨å»ºè­°

âœ… **å·²å¯¦ç¾ï¼š**

- Token ä½¿ç”¨å¾Œç«‹å³å¤±æ•ˆ
- Token æœ‰æ™‚é–“é™åˆ¶
- éæœŸ Token è‡ªå‹•æ¸…ç†
- ä½¿ç”¨å¯†ç¢¼å­¸å®‰å…¨çš„éš¨æ©Ÿç”Ÿæˆå™¨

âš ï¸ **å¯é¸å¢å¼·ï¼š**

- è¨˜éŒ„ Token ä½¿ç”¨ IP åœ°å€
- Token ç¶å®šä½¿ç”¨è€…æš±ç¨±
- Token ä½¿ç”¨æ¬¡æ•¸é™åˆ¶
- Token é»‘åå–®æ©Ÿåˆ¶

---

## Socket ID è™•ç†æ©Ÿåˆ¶

### å•é¡Œæè¿°

**Socket ID åœ¨ä¸åŒé é¢é–“æœƒè®ŠåŒ–**ï¼Œå°è‡´æ§åˆ¶æ¬Šæˆäºˆå¤±æ•—ï¼š

```
èŠå¤©å®¤é é¢                 æ§åˆ¶é é¢
Socket ID: R1oq...   â†’   Socket ID: 5iEaP... ï¼ˆä¸åŒï¼ï¼‰
     â†“                         â†“
  è¢«è¨­å®šç‚ºæ§åˆ¶è€…           ç„¡æ³•ç²å¾—æ§åˆ¶æ¬Š âŒ
```

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä¸ç«‹å³è¨­å®šæ§åˆ¶è€…ï¼ˆç•¶å‰æ–¹æ¡ˆï¼‰

**åŸç†ï¼š** ä¸åœ¨èŠå¤©å®¤å°±è¨­å®šæ§åˆ¶è€…ï¼Œè€Œæ˜¯è®“ç²å‹è€…é€šé Token ç²å–æ§åˆ¶æ¬Šã€‚

**å¯¦ä½œï¼š**

```python
# award_control_to_winner() ä¸­ï¼š
# âŒ ä¸è¦é€™æ¨£åšï¼š
self.control_active = True
self.current_controller = winner_user_id  # èŠå¤©å®¤çš„ Socket ID

# âœ… æ­£ç¢ºåšæ³•ï¼š
# åªç™¼é€æ§åˆ¶é€£çµï¼Œä¸è¨­å®šæ§åˆ¶è€…
self.socketio.emit('control_link', {
    'url': control_url,
    'token': token
}, room=winner_user_id)

# ç•¶ç²å‹è€…é»æ“Šé€£çµé€²å…¥æ§åˆ¶é é¢æ™‚ï¼š
# å‰ç«¯æª¢æ¸¬ URL ä¸­çš„ token
# è‡ªå‹•èª¿ç”¨ emit('claim_token', {token})
# å¾Œç«¯é©—è­‰ token å¾Œï¼Œæˆäºˆæ§åˆ¶æ¬Šçµ¦æ–°çš„ Socket ID
```

**å„ªé»ï¼š**

- âœ… è§£æ±º Socket ID ä¸ä¸€è‡´å•é¡Œ
- âœ… æ”¯æ´è·¨è¨­å‚™è¨ªå•ï¼ˆç²å‹è€…å¯ä»¥ç”¨ä¸åŒè¨­å‚™é–‹å•Ÿé€£çµï¼‰
- âœ… æ›´å®‰å…¨ï¼ˆToken é©—è­‰ï¼‰

#### æ–¹æ¡ˆ 2: ä½¿ç”¨ Token å¼·åˆ¶æ¥ç®¡ï¼ˆç•¶å‰æ–¹æ¡ˆï¼‰

**åŸç†ï¼š** ç•¶ä½¿ç”¨ Token æ™‚ï¼Œå¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…ã€‚

**å¯¦ä½œï¼š**

```python
@self.socketio.on('claim_token')
def handle_claim_token(data):
    token = data.get('token')
    sid = request.sid

    # é©—è­‰ Token
    if not self.validate_and_use_token(token):
        emit('control_denied', {'message': 'ç„¡æ•ˆæˆ–å·²éæœŸçš„ token'})
        return

    # â˜… é—œéµï¼šå¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…
    if self.control_active and self.current_controller != sid:
        old_controller = self.current_controller

        # é€šçŸ¥èˆŠæ§åˆ¶è€…
        self.socketio.emit('control_revoked', {
            'reason': 'æ–°çš„ç²å‹è€…ä½¿ç”¨ token ç²å–æ§åˆ¶æ¬Š',
            'message': 'æ§åˆ¶æ¬Šå·²è¢«æ–°çš„ç²å‹è€…æ¥ç®¡'
        }, room=old_controller)

    # æˆäºˆæ§åˆ¶æ¬Šçµ¦æ–°çš„ Socket ID
    self.control_active = True
    self.current_controller = sid

    emit('control_granted', {'controller_id': sid})
```

**å„ªé»ï¼š**

- âœ… æ”¯æ´å¤šäººç«¶çˆ­ï¼ˆå¾Œä¾†è€…å¼·åˆ¶æ¥ç®¡ï¼‰
- âœ… è‡ªå‹•è§£æ±ºè¡çª
- âœ… æœ‰æ˜ç¢ºçš„é€šçŸ¥æ©Ÿåˆ¶

### å‰ç«¯è‡ªå‹•æª¢æ¸¬ Token

```javascript
// remote_control.html
socket.on('connect', () => {
  // æª¢æŸ¥ URL ä¸­çš„ token åƒæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  if (token) {
    // ä½¿ç”¨ Token ç²å–æ§åˆ¶æ¬Šï¼ˆæœƒå¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…ï¼‰
    console.log('ğŸ« æª¢æ¸¬åˆ° tokenï¼Œä½¿ç”¨ claim_token ç²å–æ§åˆ¶æ¬Š');
    socket.emit('claim_token', { token: token });
  } else {
    // ä¸€èˆ¬æ§åˆ¶æ¬Šè«‹æ±‚
    socket.emit('control_start');
  }
});
```

---

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è¦‹å•é¡Œ

#### 1. å€’æ•¸çµæŸå¾Œæ²’æœ‰æ”¶åˆ° `chat_session_ended` äº‹ä»¶

**ç—‡ç‹€ï¼š**

- å‰ç«¯å€’æ•¸è¨ˆæ™‚æ­£å¸¸ï¼ˆ60, 59, 58...ï¼‰
- æ”¶åˆ° `chat_timer_ended` äº‹ä»¶
- ä½†æ²’æœ‰æ”¶åˆ° `chat_session_ended` äº‹ä»¶
- Toastify ä¸æœƒå½ˆå‡ºæ§åˆ¶é€£çµ

**åŸå› ï¼š**

- æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`chat_timer_countdown()` å€’æ•¸çµæŸå¾Œæ²’æœ‰è‡ªå‹•èª¿ç”¨ `end_chat_session()`
- éœ€è¦ç­‰å¾…ç”¨æˆ¶æ¸…é†’ 30 ç§’å¾Œæ‰æœƒèª¿ç”¨

**è§£æ±ºæ–¹æ³•ï¼š**
âœ… å·²ä¿®å¾©ï¼ˆL874-875ï¼‰ï¼š

```python
# æ™‚é–“åˆ°ï¼Œè‡ªå‹•çµæŸèŠå¤©æœƒè©±ä¸¦è¨ˆç®—æœ€é«˜ç¥¨
if self.chat_timer_active:
    self.end_chat_session()  # â† è‡ªå‹•èª¿ç”¨
```

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰å°å‡ºï¼š`"â° èŠå¤©æ™‚é–“çµæŸï¼Œé–‹å§‹è¨ˆç®—æœ€é«˜ç¥¨..."`
2. æª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰ï¼š`"ğŸ“¥ æ”¶åˆ°äº‹ä»¶: chat_session_ended"`
3. ç¢ºèª `web_remote_control.py` L874-875 æ˜¯å¦æœ‰ `self.end_chat_session()`

---

#### 2. é»æ“Šæ§åˆ¶é€£çµå¾Œè¢«æ‹’çµ•æ§åˆ¶æ¬Š

**ç—‡ç‹€ï¼š**

- æ”¶åˆ° Toastify é€šçŸ¥å’Œæ§åˆ¶é€£çµ
- é»æ“Šã€ŒğŸ”— é–‹å•Ÿã€æŒ‰éˆ•
- é€²å…¥æ§åˆ¶é é¢å¾Œé¡¯ç¤ºï¼šã€ŒâŒ æ‹’çµ•æ§åˆ¶æ¬Šè«‹æ±‚ - å·²æœ‰å…¶ä»–æ§åˆ¶è€…ã€

**åŸå› ï¼š**

- Socket ID åœ¨ä¸åŒé é¢é–“è®ŠåŒ–
- å¾Œç«¯åœ¨èŠå¤©å®¤å°±è¨­å®šäº†æ§åˆ¶è€…ï¼ˆèˆŠ Socket IDï¼‰
- æ§åˆ¶é é¢ä½¿ç”¨æ–° Socket IDï¼Œä½†å¾Œç«¯èªç‚ºå·²æœ‰æ§åˆ¶è€…

**è§£æ±ºæ–¹æ³•ï¼š**
âœ… å·²ä¿®å¾©ï¼š

1. `award_control_to_winner()` ä¸å†ç«‹å³è¨­å®šæ§åˆ¶è€…ï¼ˆL998-1002ï¼‰
2. `claim_token` äº‹ä»¶æœƒå¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…ï¼ˆL620-629ï¼‰
3. å‰ç«¯è‡ªå‹•æª¢æ¸¬ä¸¦ä½¿ç”¨ URL ä¸­çš„ tokenï¼ˆL800-812ï¼‰

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰ï¼š`"ğŸ« ç‚ºç²å‹è€… XXX ç”Ÿæˆæ§åˆ¶é€£çµï¼ˆåŒ…å« tokenï¼‰"`
2. æª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰ï¼š`"ğŸ« æª¢æ¸¬åˆ° tokenï¼Œä½¿ç”¨ claim_token ç²å–æ§åˆ¶æ¬Š"`
3. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰ï¼š`"âœ… ä½¿ç”¨ token æˆäºˆæ§åˆ¶æ¬Š: 5iEaPtwFava4GmmhAAAZ"`

---

#### 3. æ²’æœ‰è¨Šæ¯æ™‚å€’æ•¸çµæŸæœƒå ±éŒ¯

**ç—‡ç‹€ï¼š**

- å€’æ•¸çµæŸæ™‚æ²’æœ‰ä»»ä½•ç•™è¨€
- å¾Œç«¯å ±éŒ¯æˆ–å‰ç«¯é¡¯ç¤ºç•°å¸¸

**åŸå› ï¼š**

- `get_top_voted_message()` è¿”å› `None`
- å‰ç«¯å˜—è©¦è¨ªå• `top_message.username` æœƒå ±éŒ¯

**è§£æ±ºæ–¹æ³•ï¼š**
âœ… å·²è™•ç†ï¼ˆL899-905ï¼‰ï¼š

```python
if top_message:
    # æœ‰ç²å‹è€…
    self.socketio.emit('chat_session_ended', {
        'top_message': top_message,
        'control_url': control_url
    })
else:
    # æ²’æœ‰ç²å‹è€…
    self.socketio.emit('chat_session_ended', {
        'top_message': None,
        'control_url': None
    })
```

å‰ç«¯ä¹Ÿæœ‰è™•ç†ï¼ˆL603-619ï¼‰ï¼š

```javascript
if (d.top_message) {
  // é¡¯ç¤ºç²å‹è€…è³‡è¨Š
} else {
  chatStatus.textContent = 'ğŸ’¬ ä¸»äººé†’ä¾†äº†ï¼';
}
```

---

#### 4. Token å·²éæœŸæˆ–ç„¡æ•ˆ

**ç—‡ç‹€ï¼š**

- é»æ“Šæ§åˆ¶é€£çµå¾Œé¡¯ç¤ºï¼šã€Œç„¡æ•ˆæˆ–å·²éæœŸçš„ tokenã€

**åŸå› ï¼š**

1. Token å·²ä½¿ç”¨éï¼ˆä¸€æ¬¡æ€§ï¼‰
2. Token å·²éæœŸï¼ˆè¶…é 5 åˆ†é˜ï¼‰
3. Token ä¸å­˜åœ¨

**è§£æ±ºæ–¹æ³•ï¼š**

- é‡æ–°ç²å¾—æ§åˆ¶æ¬Šï¼ˆéœ€è¦å†æ¬¡æˆç‚ºæœ€é«˜ç¥¨ï¼‰
- æˆ–è€…èª¿æ•´ Token æœ‰æ•ˆæœŸï¼š

```python
# web_remote_control.py L943
token = self.generate_one_time_token(ttl=300)  # æ”¹æˆæ›´é•·æ™‚é–“ï¼ˆç§’ï¼‰
```

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰ï¼š`"[TOKEN] generated token=XXX ttl=300s"`
2. ç¢ºèªé»æ“Šé€£çµçš„æ™‚é–“æ˜¯å¦åœ¨ 5 åˆ†é˜å…§
3. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰ï¼š`"âš ï¸ ç„¡æ•ˆæˆ–å·²éæœŸçš„ token"`

---

#### 5. å¤šäººåŒæ™‚ç²å¾—æ§åˆ¶æ¬Š

**ç—‡ç‹€ï¼š**

- å¤šäººåŒæ™‚å¯ä»¥æ§åˆ¶æ°´æ§
- æˆ–è€…æ§åˆ¶æ¬Šåœ¨å¤šäººä¹‹é–“è·³å‹•

**åŸå› ï¼š**

- Token è¢«åˆ†äº«çµ¦å¤šäºº
- æˆ–è€… Token å®‰å…¨æ©Ÿåˆ¶å¤±æ•ˆ

**è§£æ±ºæ–¹æ³•ï¼š**
âœ… å·²å¯¦ç¾ä¸€æ¬¡æ€§ Tokenï¼š

```python
# Token ä½¿ç”¨å¾Œç«‹å³æ¨™è¨˜ç‚º used
info['used'] = True
```

âœ… å·²å¯¦ç¾å¼·åˆ¶æ’¤éŠ·ï¼š

```python
# ä½¿ç”¨ Token æ™‚å¼·åˆ¶æ’¤éŠ·èˆŠæ§åˆ¶è€…
if self.control_active and self.current_controller != sid:
    # æ’¤éŠ·èˆŠæ§åˆ¶è€…
```

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. ç¢ºèª `validate_and_use_token()` æœ‰æ­£ç¢ºæ¨™è¨˜ `used`
2. ç¢ºèª `claim_token` æœ‰å¼·åˆ¶æ’¤éŠ·æ©Ÿåˆ¶
3. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰å¤šæ¬¡ `"âœ… ä½¿ç”¨ token æˆäºˆæ§åˆ¶æ¬Š"`

---

### é™¤éŒ¯æŠ€å·§

#### 1. å•Ÿç”¨ Debug æ¨¡å¼

**å‰ç«¯ï¼ˆchat.html L303-317ï¼‰ï¼š**

```javascript
// Debug: ç›£è½æ‰€æœ‰äº‹ä»¶
const originalOn = socket.on.bind(socket);
socket.on = function (event, callback) {
  return originalOn(event, function (...args) {
    console.log(`ğŸ“¥ æ”¶åˆ°äº‹ä»¶: ${event}`, args); // â† è‡ªå‹•å°å‡ºæ‰€æœ‰äº‹ä»¶
    return callback.apply(this, args);
  });
};
```

**å¾Œç«¯ï¼š**
åœ¨é—œéµä½ç½®åŠ ä¸Š `print()` èªå¥ï¼š

```python
def end_chat_session(self):
    print(f"\nğŸ”” end_chat_session() è¢«èª¿ç”¨ï¼")
    print(f"   chat_active = {self.chat_active}")
    # ...
```

#### 2. æª¢æŸ¥ Socket é€£æ¥

**å‰ç«¯ Consoleï¼š**

```javascript
// æª¢æŸ¥ Socket æ˜¯å¦é€£æ¥
console.log('Socket connected:', socket.connected);
console.log('Socket ID:', socket.id);
```

**å¾Œç«¯ï¼š**

```python
print(f"é€£æ¥çš„å®¢æˆ¶ç«¯: {self.connected_clients}")
print(f"ç•¶å‰æ§åˆ¶è€…: {self.current_controller}")
```

#### 3. æŸ¥çœ‹ Token ç‹€æ…‹

```python
# web_remote_control.py
print(f"ç•¶å‰ Tokens: {self.one_time_tokens}")
```

---

## é–‹ç™¼æ³¨æ„äº‹é …

### 1. æ™‚é–“åŒæ­¥

âš ï¸ **æ³¨æ„ï¼š** å‰ç«¯å’Œå¾Œç«¯çš„å€’æ•¸è¨ˆæ™‚å¯èƒ½æœƒæœ‰ 1-2 ç§’çš„èª¤å·®ã€‚

**åŸå› ï¼š**

- ç¶²è·¯å»¶é²
- JavaScript `setTimeout()` ç²¾åº¦å•é¡Œ

**å»ºè­°ï¼š**

- ä»¥å¾Œç«¯æ™‚é–“ç‚ºæº–
- å‰ç«¯é¡¯ç¤ºåƒ…ä¾›åƒè€ƒ

### 2. å¤šè£ç½®æ”¯æ´

âœ… **å·²æ”¯æ´ï¼š** ç²å‹è€…å¯ä»¥åœ¨ä¸åŒè£ç½®ä¸Šé–‹å•Ÿæ§åˆ¶é€£çµã€‚

**å¯¦ä½œæ–¹å¼ï¼š**

- ä½¿ç”¨ Token è€Œé Socket ID
- Token å¯ä»¥è·¨è£ç½®ä½¿ç”¨

**é™åˆ¶ï¼š**

- Token æ˜¯ä¸€æ¬¡æ€§çš„
- å¾Œé–‹å•Ÿçš„è£ç½®æœƒå¼·åˆ¶æ¥ç®¡æ§åˆ¶æ¬Š

### 3. ä¸¦ç™¼æ§åˆ¶

âš ï¸ **æ³¨æ„ï¼š** å¤šäººåŒæ™‚æŠ•ç¥¨æˆ–ç•™è¨€æ™‚ï¼Œå¯èƒ½æœƒæœ‰ç«¶çˆ­æ¢ä»¶ã€‚

**å·²è™•ç†ï¼š**

- ä½¿ç”¨ `room='controllers'` å»£æ’­
- æŠ•ç¥¨æª¢æŸ¥åœ¨å¾Œç«¯é€²è¡Œ

**å»ºè­°ï¼š**

- å¦‚æœéœ€è¦æ›´é«˜ä¸¦ç™¼ï¼Œè€ƒæ…®ä½¿ç”¨è³‡æ–™åº«é–
- æˆ–è€…ä½¿ç”¨ Redis å„²å­˜æŠ•ç¥¨ç‹€æ…‹

### 4. æ¸…ç†æ©Ÿåˆ¶

âœ… **å·²å¯¦ç¾ï¼š**

- Token éæœŸè‡ªå‹•æ¸…ç†
- èŠå¤©è¨Šæ¯ 5 ç§’å¾Œæ¸…ç©º
- æŠ•ç¥¨è¨˜éŒ„éš¨èŠå¤©æœƒè©±æ¸…ç©º

**å»ºè­°ï¼š**

- å®šæœŸæª¢æŸ¥ `self.one_time_tokens` å¤§å°
- è€ƒæ…®åŠ å…¥æœ€å¤§ Token æ•¸é‡é™åˆ¶

### 5. éŒ¯èª¤è™•ç†

âœ… **å·²è™•ç†ï¼š**

- Socket æ–·ç·šè‡ªå‹•æ¸…ç†
- Token é©—è­‰å¤±æ•—å›å‚³éŒ¯èª¤
- ç•™è¨€/æŠ•ç¥¨å¤±æ•—é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

**å»ºè­°ï¼š**

- åŠ å…¥æ›´è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ
- è€ƒæ…®ä½¿ç”¨ Sentry ç­‰éŒ¯èª¤è¿½è¹¤æœå‹™

### 6. æ•ˆèƒ½å„ªåŒ–

**ç•¶å‰ç“¶é ¸ï¼š**

- æ¯ç§’å»£æ’­ `chat_timer_update` çµ¦æ‰€æœ‰äºº
- Socket.IO é€£æ¥æ•¸é™åˆ¶

**å„ªåŒ–å»ºè­°ï¼š**

- è€ƒæ…®æ”¹ç”¨å‰ç«¯å€’æ•¸ï¼ˆå¾Œç«¯åªç™¼é€é–‹å§‹/çµæŸäº‹ä»¶ï¼‰
- ä½¿ç”¨ Redis å„²å­˜èŠå¤©ç‹€æ…‹
- æ°´å¹³æ“´å±•ï¼ˆå¤šå€‹ Flask å¯¦ä¾‹ï¼‰

### 7. å®‰å…¨æ€§

âœ… **å·²å¯¦ç¾ï¼š**

- å¯†ç¢¼é©—è­‰ï¼ˆ`auth` åƒæ•¸ï¼‰
- Token é©—è­‰ï¼ˆä¸€æ¬¡æ€§ + æ™‚æ•ˆæ€§ï¼‰
- ç•™è¨€é•·åº¦é™åˆ¶ï¼ˆ50 å­—ï¼‰
- æš±ç¨±é•·åº¦é™åˆ¶ï¼ˆ20 å­—ï¼‰

âš ï¸ **å»ºè­°åŠ å¼·ï¼š**

- XSS é˜²è­·ï¼ˆç•™è¨€å…§å®¹éæ¿¾ï¼‰
- CSRF é˜²è­·
- Rate Limitingï¼ˆé˜²æ­¢åˆ·ç¥¨ï¼‰
- IP å°é–æ©Ÿåˆ¶

---

## é™„éŒ„

### A. Socket.IO æˆ¿é–“æ©Ÿåˆ¶

```python
# 'controllers' æˆ¿é–“åŒ…å«æ‰€æœ‰é€£æ¥çš„å®¢æˆ¶ç«¯
join_room('controllers')

# å»£æ’­çµ¦æ‰€æœ‰äºº
self.socketio.emit('event_name', data, room='controllers')

# å»£æ’­çµ¦ç‰¹å®šäºº
self.socketio.emit('event_name', data, room=specific_socket_id)

# å»£æ’­çµ¦æ‰€æœ‰äººï¼ˆä¸é™æˆ¿é–“ï¼‰
self.socketio.emit('event_name', data, broadcast=True)
```

### B. å‰ç«¯ Toastify é…ç½®

```javascript
// åŸºæœ¬é…ç½®
Toastify({
  text: 'è¨Šæ¯å…§å®¹',
  duration: 4000,
  gravity: 'top', // top, bottom
  position: 'right', // left, center, right
  close: true,
  style: {
    background: 'linear-gradient(90deg, #00b09b, #96c93d)',
  },
}).showToast();

// å¸¶ URL æŒ‰éˆ•çš„é…ç½®
Toastify({
  text: `<div>è¨Šæ¯ <a href="${url}">ğŸ”— é–‹å•Ÿ</a></div>`,
  escapeMarkup: false, // å…è¨± HTML
  destination: url, // é»æ“Šæ•´å€‹ toast è·³è½‰
  newWindow: true,
  duration: 10000, // URL é€šçŸ¥é¡¯ç¤ºæ›´ä¹…
}).showToast();
```

### C. Notification Panel è‡ªè¨‚æ¨£å¼

```css
/* ä¸åŒé¡å‹çš„é€šçŸ¥é¡è‰² */
.notification-item.info {
  background: linear-gradient(
    90deg,
    rgba(0, 212, 255, 0.2),
    rgba(0, 153, 204, 0.2)
  );
  border-left: 3px solid #00d4ff;
}

.notification-item.success {
  background: linear-gradient(
    90deg,
    rgba(0, 176, 155, 0.2),
    rgba(150, 201, 61, 0.2)
  );
  border-left: 3px solid #00b09b;
}

.notification-item.warning {
  background: linear-gradient(
    90deg,
    rgba(243, 156, 18, 0.2),
    rgba(241, 196, 15, 0.2)
  );
  border-left: 3px solid #f39c12;
}

.notification-item.error {
  background: linear-gradient(
    90deg,
    rgba(255, 95, 109, 0.2),
    rgba(255, 195, 113, 0.2)
  );
  border-left: 3px solid #ff5f6d;
}
```

### D. ç›¸é—œè³‡æº

- **Socket.IO å®˜æ–¹æ–‡ä»¶ï¼š** https://socket.io/docs/v4/
- **Flask-SocketIOï¼š** https://flask-socketio.readthedocs.io/
- **Toastify.jsï¼š** https://github.com/apvarun/toastify-js

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | è®Šæ›´å…§å®¹                    |
| ---- | ---------- | --------------------------- |
| 1.0  | 2025-12-15 | âœ… åˆå§‹ç‰ˆæœ¬                 |
|      |            | - å®ŒæˆåŸºæœ¬èŠå¤©åŠŸèƒ½          |
|      |            | - å¯¦ç¾æŠ•ç¥¨æ©Ÿåˆ¶              |
|      |            | - å¯¦ç¾ Token æˆæ¬Š           |
|      |            | - ä¿®å¾© Socket ID ä¸ä¸€è‡´å•é¡Œ |
|      |            | - è‡ªå‹•å€’æ•¸çµæŸè¨ˆç®—æœ€é«˜ç¥¨    |

---

## è¯çµ¡è³‡è¨Š

**å°ˆæ¡ˆåç¨±ï¼š** é˜²çŒç¡ç³»çµ± - äº’å‹•èŠå¤©å®¤æ¨¡çµ„
**æ–‡ä»¶ç‰ˆæœ¬ï¼š** 1.0
**æœ€å¾Œæ›´æ–°ï¼š** 2025-12-15

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯ç¹«å°ˆæ¡ˆç¶­è­·è€…ã€‚

---
